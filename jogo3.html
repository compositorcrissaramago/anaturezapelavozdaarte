<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Grid Sonoro com Imagem</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: sans-serif;
    }
    canvas {
      display: block;
      margin-left: 220px; /* deixa espaço para o painel */
    }
    /* Painel lateral fixo */
    #controlPanel {
      position: fixed;
      top: 10px;
      left: 10px;
      width: 200px;
      background: rgba(50, 50, 50, 0.8);
      padding: 10px;
      border-radius: 8px;
      backdrop-filter: blur(5px);
    }
    #controlPanel div {
      margin-bottom: 15px;
    }
    #controlPanel label {
      display: block;
      margin-bottom: 4px;
    }
    input[type=range] {
      width: 100%;
    }
    input[type=text] {
      width: 100%;
    }
    button {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: none;
      background: #444;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background: #666;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
</head>
<body>
  <div id="controlPanel">
    <div>
      <label>Velocidade (ms): <span id="speedLabel">1300</span></label>
      <input type="range" id="speedSlider" min="100" max="2000" value="1300" step="50">
    </div>
    <div>
      <label>Células: <span id="gridLabel">8</span></label>
      <input type="range" id="gridSlider" min="2" max="25" value="8" step="1">
    </div>
    <div>
      <label>Amp Max: <span id="ampLabel">0.2</span></label>
      <input type="range" id="ampSlider" min="0" max="0.5" value="0.2" step="0.01">
    </div>
    <div>
      <label>Alfa Grid: <span id="alfaLabel">150</span></label>
      <input type="range" id="alfaSlider" min="0" max="255" value="150" step="1">
    </div>
    <div>
      <label>URL da Imagem:</label>
      <input type="text" id="imgInput" value="https://s.ebiografia.com/img/an/oi/a_noite_estrelada.jpg?auto_optimize=low">
    </div>
    <div>
      <button id="startButton">Iniciar Grid</button>
    </div>
  </div>

  <script>
    let img;
    let gridSize = 8;
    let gfx;
    let currentCell = -1;
    let lastChange = 0;
    let interval = 1300;
    let maxAmp = 0.2;
    let alfaGrid = 150;

    let started = false;
    let running = false;

    let oscList = [];
    let reverb;

    // Elementos HTML
    let speedSlider, gridSlider, ampSlider, alfaSlider, imgInput, startButton;
    let speedLabel, gridLabel, ampLabel, alfaLabel;

    function preload() {
      img = loadImage("https://s.ebiografia.com/img/an/oi/a_noite_estrelada.jpg?auto_optimize=low");
    }

    function setup() {
      adjustCanvasSize();
      noStroke();
      gfx = createGraphics(gridSize, gridSize);
      gfx.pixelDensity(1);

      // Conecta elementos HTML
      speedSlider = select('#speedSlider');
      gridSlider = select('#gridSlider');
      ampSlider = select('#ampSlider');
      alfaSlider = select('#alfaSlider');
      imgInput = select('#imgInput');
      startButton = select('#startButton');

      speedLabel = select('#speedLabel');
      gridLabel = select('#gridLabel');
      ampLabel = select('#ampLabel');
      alfaLabel = select('#alfaLabel');

      startButton.mousePressed(() => { running = true; });
      imgInput.input(loadNewImage);

      reverb = new p5.Reverb();
      for (let i = 0; i < 3; i++) {
        let osc = new p5.Oscillator('sine');
        osc.start();
        osc.amp(0);
        reverb.process(osc, 2, 1.2);
        oscList.push(osc);
      }
    }

    function adjustCanvasSize() {
      if (!img) return;
      let aspectRatio = img.width / img.height;
      let canvasWidth = windowWidth - 220; // espaço do painel
      let canvasHeight = canvasWidth / aspectRatio;
      if (canvasHeight > windowHeight) {
        canvasHeight = windowHeight;
        canvasWidth = canvasHeight * aspectRatio;
      }
      createCanvas(canvasWidth, canvasHeight);
    }

    function loadNewImage() {
      let url = imgInput.value();
      if (url) {
        loadImage(url, (loadedImg) => {
          img = loadedImg;
          adjustCanvasSize();
        });
      }
    }

    function intervalIndex(baseIndex, minInterval, maxInterval, value) {
      let step = map(value, 0, 255, minInterval, maxInterval);
      return baseIndex + round(step);
    }

    function draw() {
      background(30);
      if (img) image(img, 0, 0, width, height);

      interval = map(speedSlider.value(), 100, 2000, 2000, 100);
      gridSize = constrain(gridSlider.value(), 2, 25);
      maxAmp = ampSlider.value();
      alfaGrid = alfaSlider.value();

      // atualiza labels
      speedLabel.html(int(interval));
      gridLabel.html(gridSize);
      ampLabel.html(maxAmp.toFixed(2));
      alfaLabel.html(alfaGrid);

      gfx.resizeCanvas(gridSize, gridSize);
      if (img) gfx.image(img, 0, 0, gridSize, gridSize);
      gfx.loadPixels();

      let cellW = width / gridSize;
      let cellH = height / gridSize;

      if (running && millis() - lastChange > interval) {
        currentCell = (currentCell + 1) % (gridSize * gridSize);
        lastChange = millis();
      }

      for (let gx = 0; gx < gridSize; gx++) {
        for (let gy = 0; gy < gridSize; gy++) {
          let idx = 4 * (gy * gridSize + gx);
          let r = gfx.pixels[idx];
          let g = gfx.pixels[idx + 1];
          let b = gfx.pixels[idx + 2];
          if (!isFinite(r) || !isFinite(g) || !isFinite(b)) continue;

          let cellIndex = gy * gridSize + gx;
          if (cellIndex === currentCell && running) {
            stroke(255);
            strokeWeight(3);
          } else {
            noStroke();
          }
          fill(r, g, b, alfaGrid);
          rect(gx * cellW, gy * cellH, cellW, cellH);
        }
      }

      if (started && running && currentCell >= 0) {
        let gx = currentCell % gridSize;
        let gy = floor(currentCell / gridSize);
        let idx = 4 * (gy * gridSize + gx);
        let r = gfx.pixels[idx];
        let g = gfx.pixels[idx + 1];
        let b = gfx.pixels[idx + 2];

        let escala = [174.61, 196.0, 207.65, 233.08, 261.63, 277.18, 311.13, 349.23, 392.0];
        let octaves = [4, 2, 1];

        let idxB = floor(map(b, 0, 255, 0, escala.length - 1));
        let idxG = intervalIndex(idxB, 2, 4, g);
        if (idxG >= escala.length) idxG = escala.length - 1;
        let idxR = floor(map(r, 0, 255, 0, escala.length - 1));

        oscList[0].freq(escala[idxR] * octaves[0], 0.25);
        oscList[1].freq(escala[idxG] * octaves[1], 0.15);
        oscList[2].freq(escala[idxB] * octaves[2], 0.2);

        oscList[0].amp(maxAmp / 4, 0.3);
        oscList[1].amp(maxAmp / 3, 0.3);
        oscList[2].amp(maxAmp / 1.5, 0.3);
      }
    }

    function mousePressed() {
      let ctx = getAudioContext();
      if (ctx && ctx.state !== 'running') ctx.resume();
      started = true;
    }

    function windowResized() {
      adjustCanvasSize();
    }
  </script>
</body>
</html>
