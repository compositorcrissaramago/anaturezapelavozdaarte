<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jogo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
    }
    #gameContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100vw;
      height: 100vh;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
  <div id="gameContainer"></div>

  <script>
    let container;
    let canvas;
    let sizeCanvas;

    let img;
    let vol, timb;
    let osc1, osc2;
    let freq;
    let cor1, cor2, cor3, alfa;
    let n;
    let escn = ["Maior", "Menor H", "Menor M", "Mixolídio", "Dórico"];
    let escalas;
    let botaoAtivo = -1;

    let escalaMaior = [174.61,196,220,233.08,261.63,293.66,329.63,349.23,392,440,466.16,523.25,587.33,659.26,698.46];
    let escalaMenorHarmonica = [174.61,196,207.65,233.08,261.63,277.18,329.63,349.23,392,415.3,466.16,523.25,554.36,659.26,698.46];
    let escalaMenorMelodica = [174.61,196,207.65,233.08,261.63,293.66,329.63,349.23,392,415.3,466.16,523.25,587.33,659.26,698.46];
    let escalaMixolidia = [174.61,196,220,233.08,261.63,293.66,311.13,349.23,392,440,466.16,523.25,587.33,622.25,698.46];
    let escalaDorica = [174.61,196,207.65,233.08,261.63,293.66,311.13,349.23,392,415.3,466.16,523.25,587.33,622.25,698.46];

    let escalasPorBotao = [escalaMaior, escalaMenorHarmonica, escalaMenorMelodica, escalaMixolidia, escalaDorica];
    let nBotoes = 5;
    let larguraBotao, alturaBotao;

    function preload() {
      img = loadImage("https://raw.githubusercontent.com/compositorcrissaramago/anaturezapelavozdaarte/refs/heads/main/attached_assets/Gemini_Generated_Image_epd613epd613epd6.png");
    }

    function setup() {
      container = select('#gameContainer');
      sizeCanvas = min(windowWidth, windowHeight);
      canvas = createCanvas(sizeCanvas, sizeCanvas);
      canvas.parent(container);

      // Osciladores
      osc1 = new p5.Oscillator("sine"); osc1.amp(0);
      osc2 = new p5.Oscillator("square"); osc2.amp(0);

      freq = 349.23;
      osc1.freq(freq); osc2.freq(freq);

      n = 7;
      larguraBotao = width / nBotoes;
      alturaBotao = height / 6;

      escalas = escalaMaior;
    }

    function windowResized() {
      sizeCanvas = min(windowWidth, windowHeight);
      resizeCanvas(sizeCanvas, sizeCanvas);
      larguraBotao = width / nBotoes;
      alturaBotao = height / 6;
    }

    function draw() {
      background(0);

      // Imagem proporcional
      let imgAspect = img.width / img.height;
      let canvasAspect = width / height;
      let drawWidth, drawHeight;
      if(canvasAspect > imgAspect){
        drawHeight = height;
        drawWidth = imgAspect * height;
      } else {
        drawWidth = width;
        drawHeight = width / imgAspect;
      }
      let xi = (width - drawWidth)/2;
      let yi = (height - drawHeight)/2;
      image(img, xi, yi, drawWidth, drawHeight);

      // Textos
      textFont('cursive'); noStroke();
      fill("red"); textSize(60); textAlign(LEFT);
      text("SQUARE", width*0.02, height-height/3);
      fill("blue"); textAlign(RIGHT); text("SINE", width - width*0.05, height-height/3);
      fill("lightgreen"); textAlign(CENTER); text("Volume", width/2, height/8);

      fill(255); textSize(25);
      text("1.Escolha um modo escalar", width/2,  height/4);
      text("2.Click, segure e arraste pela tela", width/2,  height/3.6);
      text("3.MouseScroll para notas da escala", width/2,  height/3.3);

      // Mapeamento
      vol = map(mouseY, height - alturaBotao, 0, 0, 1);
      cor3 = map(mouseX, 0, width, 60, 255);
      cor2 = map(freq, 200, 600, 80, 255);
      cor1 = map(mouseX, width, 0, 60, 255);
      alfa = map(mouseY, height, 0, 60, 255);

      // Som interativo
      if(mouseIsPressed && mouseY < height - alturaBotao){
        osc1.freq(freq); osc1.amp(map(mouseX, 0, width, 0, 1) * vol, 0.1);
        osc2.freq(freq); osc2.amp(map(mouseX, width, 0, 0, 0.05) * vol, 0.1);
        fill(cor1, cor2, cor3, alfa);
        circle(mouseX, mouseY, map(vol,0,1,10,200));
      } else {
        osc1.amp(0,0.1); osc2.amp(0,0.1);
      }

      // Botões
      for(let i=0;i<nBotoes;i++){
        let xBotao = i*larguraBotao;
        let yBotao = height - alturaBotao;
        fill(255*(1/(i+1)),130,150+i*20);
        rect(xBotao,yBotao,larguraBotao,alturaBotao);
        fill(255); textAlign(CENTER,CENTER); textSize(16);
        text(escn[i], xBotao + larguraBotao/2, yBotao + alturaBotao/2);
      }

      // Botão ativo
      if(botaoAtivo>=0){
        let xBotao = botaoAtivo * larguraBotao;
        let yBotao = height - alturaBotao;
        fill(255,255,0,100); noStroke();
        rect(xBotao,yBotao,larguraBotao,alturaBotao);
      }
    }

    function mouseClicked(){
      userStartAudio().then(()=>{
        if(!osc1.started) osc1.start();
        if(!osc2.started) osc2.start();
      });

      if(mouseY>height-alturaBotao){
        let indiceBotao = floor(mouseX/larguraBotao);
        escalas = escalasPorBotao[indiceBotao];
        n = 0;
        freq = escalas[n];
        botaoAtivo = indiceBotao;
        print(escn[indiceBotao]);
      }
    }

    function mouseWheel(event){
      if(!escalas) return;
      if(event.delta<0 && n<escalas.length-1) n++;
      else if(event.delta>0 && n>0) n--;
      freq = escalas[n];
    }
  </script>
</body>
</html>
